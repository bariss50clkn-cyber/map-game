<script>
    let provinces = [];
    const userColors = {};

    fetch('map.svg')
        .then(res => res.text())
        .then(svgData => {
            document.getElementById('svg-holder').innerHTML = svgData;
            const svg = document.querySelector('svg');
            svgPanZoom(svg, { zoomEnabled: true, controlIconsEnabled: false, fit: true, center: true });
            provinces = Array.from(document.querySelectorAll('path'));
            document.getElementById('status').innerText = "Bağlantı Hazır!";
        });

    // HEM WEBHOOK HEM MESSAGE DINLEYICISI
    const processData = (data) => {
        // TikFinity'den gelen farklı veri formatlarını kontrol eder
        const user = data.nickname || data.user || "Anonim";
        const miktar = parseInt(data.diamondCount || data.amount || 1);
        
        if (!userColors[user]) {
            userColors[user] = `hsl(${Math.random() * 360}, 70%, 50%)`;
        }

        let sehirSayisi = miktar >= 5000 ? provinces.length : (miktar >= 100 ? 5 : 1);
        
        for (let i = 0; i < sehirSayisi; i++) {
            const boslar = provinces.filter(p => !p.getAttribute('data-owner'));
            const hedef = boslar.length > 0 ? boslar[Math.floor(Math.random() * boslar.length)] : provinces[Math.floor(Math.random() * provinces.length)];
            
            if (target) {
                target.style.fill = userColors[user];
                target.setAttribute('data-owner', user);
            }
        }
    };

    // Bu kısım TikFinity Webhook tetiklemelerini yakalar
    window.addEventListener('message', (event) => processData(event.data));
</script>
