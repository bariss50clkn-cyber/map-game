<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harita Savaşı - Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #0b0e14; overflow: hidden; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #svg-holder { width: 100vw; height: 100vh; }
        path, polygon, circle, rect { transition: fill 0.6s cubic-bezier(0.4, 0, 0.2, 1); stroke: #121418; stroke-width: 0.2; }
        .ui-panel { position: absolute; top: 15px; left: 15px; background: rgba(15, 20, 30, 0.9); padding: 15px; border-radius: 12px; z-index: 1000; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); min-width: 200px; }
        #status { color: #4ade80; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; }
        #status::before { content: ''; display: inline-block; width: 10px; height: 10px; background: #4ade80; border-radius: 50%; margin-right: 8px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .log-entry { font-size: 13px; color: #ffd700; margin-top: 8px; border-top: 1px solid #333; padding-top: 8px; }
        #alert-msg { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-size: 24px; font-weight: bold; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,1); pointer-events: none; z-index: 2000; text-align: center; display: none; }
    </style>
</head>
<body>

<div id="alert-msg"></div>
<div class="ui-panel">
    <div id="status">SİSTEM AKTİF</div>
    <div id="stats" style="font-size: 12px; color: #aaa;">Feth edilen yer: 0</div>
    <div id="log" class="log-entry">Hediye bekleniyor...</div>
    <button onclick="testHediye()" style="margin-top:10px; background:#222; color:#fff; border:1px solid #444; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:10px;">El İle 500 Jeton Testi</button>
</div>

<div id="svg-holder"></div>

<script>
    let provinces = [];
    const userColors = {};
    let totalConquered = 0;

    // 1. Haritayı Yükle
    fetch('map.svg').then(res => res.text()).then(data => {
        const holder = document.getElementById('svg-holder');
        holder.innerHTML = data;
        const svg = holder.querySelector('svg');
        svgPanZoom(svg, { zoomEnabled: true, controlIconsEnabled: false, fit: true, center: true });
        provinces = Array.from(holder.querySelectorAll('path, polygon, circle, rect'));
    });

    // 2. Ana Boyama Fonksiyonu
    const boyaSavas = (user, amount) => {
        if (!provinces.length) return;
        if (!user) user = "Gizli Oyuncu";
        
        // Kullanıcıya özel renk belirle
        if (!userColors[user]) {
            userColors[user] = `hsl(${Math.random() * 360}, 85%, 60%)`;
        }

        // Jeton miktarına göre fetih gücü
        // 1 jeton = 1 şehir, 500 jeton = 50 şehir
        let power = Math.max(1, Math.floor(amount / 10)); 
        if (amount >= 500) power = 75; // 500 jeton üstü dev fetih

        // Görsel efekt
        const alertMsg = document.getElementById('alert-msg');
        alertMsg.innerHTML = `<span style="color:${userColors[user]}">${user}</span> <br> ${amount} Jetonla Saldırdı!`;
        alertMsg.style.display = 'block';
        setTimeout(() => { alertMsg.style.display = 'none'; }, 3000);

        // Fetih işlemi
        for (let i = 0; i < power; i++) {
            const unclaimed = provinces.filter(p => !p.getAttribute('data-owner'));
            const target = unclaimed.length > 0 ? unclaimed[Math.floor(Math.random() * unclaimed.length)] : provinces[Math.floor(Math.random() * provinces.length)];
            
            if (target) {
                target.style.fill = userColors[user];
                target.setAttribute('data-owner', user);
                totalConquered++;
            }
        }

        document.getElementById('log').innerText = `${user}: +${power} Bölge`;
        document.getElementById('stats').innerText = `Feth edilen yer: ${totalConquered}`;
    };

    // 3. TikFinity Sinyal Takibi
    setInterval(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.has('user')) {
            const u = params.get('user');
            const a = parseInt(params.get('amount')) || 1;
            boyaSavas(u, a);
            window.history.replaceState({}, document.title, "/");
        }
    }, 400);

    // Test Butonu Fonksiyonu
    function testHediye() {
        boyaSavas("Test_User", 500);
    }
</script>
</body>
</html>
