<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Global Fetih - TikTok CanlÄ±</title>
    <script src="https://cdn.jsdelivr.net/npm/tiktok-live-connector@latest/dist/browser-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #282c34; overflow: hidden; color: white; font-family: sans-serif; }
        #svg-holder { width: 100vw; height: 100vh; background: #c8c8c8; }
        path { fill: #d8d8d8; stroke: #666; stroke-width: 0.2; transition: all 0.4s; }
        .ui-panel { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 10px; z-index: 1000; border: 1px solid #444; }
        .user-label { font-size: 5px; font-weight: bold; fill: white; text-shadow: 1px 1px 1px black; pointer-events: none; }
    </style>
</head>
<body>

<div class="ui-panel">
    <div id="status" style="color:#ff4444; font-weight:bold;">BAÄžLANILIYOR...</div>
    <div id="stats" style="font-size:12px; margin-top:5px;">Toplam Fetih: 0</div>
    <div id="log" style="font-size:11px; color:#ffd700; margin-top:5px;">TikTok adÄ±nÄ± girin...</div>
</div>

<div id="svg-holder"></div>

<script>
    let provinces = [];
    const userColors = {}; 
    let totalConquered = 0;
    
    // --- AYAR: BURAYA KENDÄ° TIKTOK ADINI YAZ ---
    const TIKTOK_USERNAME = "barbarpm"; 

    // 1. HaritayÄ± YÃ¼kle
    fetch('map.svg').then(res => res.text()).then(data => {
        document.getElementById('svg-holder').innerHTML = data;
        const svg = document.querySelector('svg');
        svgPanZoom(svg, { zoomEnabled: true, controlIconsEnabled: false, fit: true, center: true });
        provinces = Array.from(document.querySelectorAll('path, polygon, circle, rect'));
        provinces.forEach((p, i) => p.id = p.id || 'reg_' + i);
    });

    // 2. TikTok BaÄŸlantÄ±sÄ±nÄ± BaÅŸlat
    let tiktokChatConnection = new TikTokLiveConnector.TikTokConnection(TIKTOK_USERNAME);

    tiktokChatConnection.connect().then(state => {
        document.getElementById('status').innerText = "CANLI BAÄžLANTI: OK ðŸŸ¢";
        document.getElementById('status').style.color = "#4ade80";
    }).catch(e => {
        document.getElementById('status').innerText = "BAÄžLANTI HATASI!";
        console.error(e);
    });

    // 3. Hediye OlayÄ±nÄ± Dinle
    tiktokChatConnection.on('gift', (data) => {
        const user = data.nickname;
        const amount = data.diamondCount;
        executeAttack(user, amount);
    });

    // 4. Fetih Fonksiyonu
    function executeAttack(user, amount) {
        if (!userColors[user]) {
            userColors[user] = `hsl(${Math.random() * 360}, 85%, 55%)`;
        }
        const color = userColors[user];
        let power = amount >= 500 ? 50 : Math.ceil(amount / 5);

        for (let i = 0; i < power; i++) {
            const potential = provinces.filter(p => p.getAttribute('data-owner') !== user);
            const target = potential[Math.floor(Math.random() * potential.length)];
            
            if (target) {
                target.style.fill = color;
                target.style.stroke = color;
                target.style.strokeWidth = "0.05";
                target.setAttribute('data-owner', user);
                totalConquered++;
                addLabel(target, user);
            }
        }
        document.getElementById('stats').innerText = "Toplam Fetih: " + totalConquered;
        document.getElementById('log').innerText = user + " saldÄ±rdÄ±! (" + amount + " Jeton)";
    }

    function addLabel(el, name) {
        const svg = el.ownerSVGElement;
        const bbox = el.getBBox();
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", bbox.x + bbox.width/2);
        text.setAttribute("y", bbox.y + bbox.height/2);
        text.setAttribute("class", "user-label");
        text.setAttribute("text-anchor", "middle");
        text.textContent = name;
        svg.appendChild(text);
    }
</script>
</body>
</html>
