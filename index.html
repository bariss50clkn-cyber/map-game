<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CanlÄ± SavaÅŸ</title>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #0b0e14; overflow: hidden; color: white; }
        #svg-holder { width: 100vw; height: 100vh; }
        path, polygon, circle, rect { transition: fill 0.5s ease; stroke: #121418; stroke-width: 0.1; }
        .ui { position: absolute; top: 15px; left: 15px; background: rgba(15, 20, 30, 0.9); padding: 15px; border-radius: 12px; z-index: 1000; border: 1px solid #444; font-family: sans-serif; }
    </style>
</head>
<body>
    <div class="ui">
        <div style="color:#4ade80; font-weight:bold;">SÄ°STEM CANLI ðŸŸ¢</div>
        <div id="log" style="font-size:12px; margin-top:5px;">Hediye bekleniyor...</div>
    </div>
    <div id="svg-holder"></div>

    <script>
        let provinces = [];
        const userColors = {};

        // 1. HaritayÄ± YÃ¼kle
        fetch('map.svg').then(res => res.text()).then(data => {
            document.getElementById('svg-holder').innerHTML = data;
            const svg = document.querySelector('svg');
            svgPanZoom(svg, { zoomEnabled: true, controlIconsEnabled: false, fit: true, center: true });
            provinces = Array.from(document.querySelectorAll('path, polygon, circle, rect'));
        });

        // 2. Boyama Fonksiyonu
        const savas = (user, amount) => {
            if (!provinces.length) return;
            if (!userColors[user]) userColors[user] = `hsl(${Math.random() * 360}, 85%, 60%)`;
            let power = amount >= 500 ? 80 : Math.ceil(amount / 5);
            for (let i = 0; i < power; i++) {
                const target = provinces[Math.floor(Math.random() * provinces.length)];
                target.style.fill = userColors[user];
            }
            document.getElementById('log').innerText = "Son SaldÄ±rÄ±: " + user;
        };

        // 3. TIKFINITY WEBHOOK DÄ°NLEME (Kritik KÄ±sÄ±m)
        // TikFinity Webhook gÃ¶nderdiÄŸinde sayfa Ã¼zerinde bu veriyi yakalamaya Ã§alÄ±ÅŸÄ±r
        window.addEventListener('message', function(event) {
            try {
                const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                if (data.nickname) {
                    savas(data.nickname, data.diamondCount || 1);
                }
            } catch (e) { 
                // EÄŸer URL Ã¼zerinden manuel gelirse
                if(window.location.search.includes('user')) {
                    const params = new URLSearchParams(window.location.search);
                    savas(params.get('user'), params.get('amount'));
                }
            }
        });

        // Yedek: URL deÄŸiÅŸimini takip et
        setInterval(() => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('user')) {
                savas(urlParams.get('user'), parseInt(urlParams.get('amount') || 1));
                window.history.replaceState({}, document.title, "/");
            }
        }, 1000);
    </script>
</body>
</html>
